name: CI

permissions:
  contents: write
  pages: write
  id-token: write

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  merge_group:
    types: [checks_requested]
  workflow_dispatch:

# Cancel previous versions of this job that are still running.
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  # [versionsync: OCAML_VERSION=5.4.0]
  OCAML_VERSION: 5.4.0
  # [versionsync: OBOL_REPO=soteria-tools/obol]
  OBOL_REPO: soteria-tools/obol
  # [versionsync: OBOL_COMMIT_HASH=bd47db0c3a7092cccac25b9432c9db82a3c18e38]
  OBOL_COMMIT_HASH: bd47db0c3a7092cccac25b9432c9db82a3c18e38
  # [versionsync: CHARON_REPO=soteria-tools/charon]
  CHARON_REPO: soteria-tools/charon
  # [versionsync: CHARON_COMMIT_HASH=79077103ea9d0493bc72315462a1c84fcdf014e0]
  CHARON_COMMIT_HASH: 79077103ea9d0493bc72315462a1c84fcdf014e0

jobs:
  build:
    name: Build and Test
    strategy:
      matrix:
        operating-system: [macos-latest] # TODO: add other operating systems
    runs-on: ${{ matrix.operating-system }}
    steps:
      # Setup steps: checkout, z3, node, ocaml and opam
      - uses: actions/checkout@v4
      - name: Check versions.json sync
        run: python3 scripts/versionsync.py check
      - name: Setup Z3
        uses: cda-tum/setup-z3@v1
        id: z3
      - name: Setup node
        uses: actions/setup-node@v4
        with:
          cache: "yarn"
      - name: Setup OCaml
        uses: ocaml/setup-ocaml@v3
        with:
          ocaml-compiler: ${{ env.OCAML_VERSION }}
          dune-cache: true
          opam-pin: false
      - name: Restore opam cache
        uses: actions/cache@v4
        with:
          path: _opam
          key: ${{ runner.os }}-${{ runner.arch }}-opam-${{ env.OCAML_VERSION }}-${{ hashFiles('*.opam') }}
          restore-keys: |
            ${{ runner.os }}-${{ runner.arch }}-opam-${{ env.OCAML_VERSION }}-
      - run: opam update
      # OCaml build
      - name: setup dependencies
        run: make ocaml-deps
      - name: Build OCaml stuff
        run: make ocaml
      - name: Check formatting
        run: make ocaml-format-check
      - name: Check that opam files were up to date
        run: make check-opam-files

      # Install Rust and Obol
      - name: Get Rust toolchain
        run: curl https://raw.githubusercontent.com/$OBOL_REPO/$OBOL_COMMIT_HASH/rust-toolchain.toml > rust-toolchain
      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
      - name: Restore Obol cache
        uses: actions/cache@v4
        id: restore-obol-cache
        with:
          path: obol-bin
          key: ${{ runner.os }}-${{ runner.arch }}-obol-${{ env.OBOL_COMMIT_HASH }}
      - name: Install Obol if not cached
        run: |
          brew install make
          ../soteria/scripts/versionsync.py pull obol --init
          cp -r ../obol/bin obol-bin
        if: ${{ !steps.restore-obol-cache.outputs.cache-hit }}
      - name: Add Obol to path
        run: echo "$PWD/obol-bin/" >> $GITHUB_PATH

      # Install Charon
      - name: Restore Charon cache
        uses: actions/cache@v4
        id: restore-charon-cache
        with:
          path: charon-bin
          key: ${{ runner.os }}-${{ runner.arch }}-charon-${{ env.CHARON_COMMIT_HASH }}
      - name: Install Charon if not cached
        run: |
          brew install make
          ../soteria/scripts/versionsync.py pull charon --init
          cp -r ../charon/bin charon-bin
        if: ${{ !steps.restore-charon-cache.outputs.cache-hit }}
      - name: Add Charon to path
        run: echo "$PWD/charon-bin/" >> $GITHUB_PATH

      # Run tests
      - name: Test
        run: make ocaml-test

      - name: Check if bv_values files were modified
        if: github.event_name == 'merge_group'
        id: check-bv-files
        run: |
          # Get the base branch commit (the commit before merge queue)
          BASE_SHA=$(git merge-base origin/main HEAD)
          
          # Check if any files in soteria/lib/bv_values were modified
          if git diff --name-only $BASE_SHA HEAD | grep -q "^soteria/lib/bv_values/"; then
            echo "modified=true" >> $GITHUB_OUTPUT
            echo "Files in soteria/lib/bv_values were modified, will run slow tests"
          else
            echo "modified=false" >> $GITHUB_OUTPUT
            echo "No files in soteria/lib/bv_values were modified, skipping slow tests"
          fi

      - name: Run slow tests (fuzz tests)
        if: github.event_name == 'merge_group' && steps.check-bv-files.outputs.modified == 'true'
        run: make ocaml-slow-tests

      # Building js stuff
      - name: Install JS dependencies
        run: yarn install
      - name: Build JS stuff
        run: yarn compile

      # Packaging OCaml distribution and sending it as artifact
      - name: Create soteria-c package
        run: make package-soteria-c
      - name: Upload soteria-c package
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.operating-system }}-soteria-c-package
          path: packages/soteria-c
          if-no-files-found: error

      - name: Create soteria-rust package
        run: make package-soteria-rust
      - name: Upload soteria-rust package
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.operating-system }}-soteria-rust-package
          path: packages/soteria-rust
          if-no-files-found: error

      - name: Build API documentation
        run: make doc

      - name: Upload documentation artifact
        uses: actions/upload-artifact@v4
        with:
          name: odoc
          path: _build/default/_doc/_html
          if-no-files-found: error
        # No need to upload artifact twice
        if: ${{ matrix.operating-system == 'macos-latest' }}

      - name: Opam Cleanup
        run: opam clean -a -r

  test-soteria-c-package:
    name: Test soteria-c Package
    strategy:
      matrix:
        operating-system: [macos-latest]
    runs-on: ${{ matrix.operating-system }}
    needs: build
    steps:
      - name: Checkout Collections-C, version where we find a bug
        uses: actions/checkout@v4
        with:
          repository: srdja/Collections-C
          ref: 67a094035b3f7159cf3f9af82c55ae63fcb86a34
      - name: Download package
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.operating-system }}-soteria-c-package
          path: soteria-c-package
      - name: Add executable permissions
        run: |
          chmod +x ./soteria-c-package/bin/soteria-c
          chmod +x ./soteria-c-package/bin/z3
      - name: Setup environment variables
        run: |
          PACKAGE_DIR="${GITHUB_WORKSPACE}/soteria-c-package"
          echo "CERB_INSTALL_PREFIX=${PACKAGE_DIR}" >> $GITHUB_ENV
          echo "DYLD_LIBRARY_PATH=${PACKAGE_DIR}/lib:${DYLD_LIBRARY_PATH}" >> $GITHUB_ENV
          echo "SOTERIA_Z3_PATH=${PACKAGE_DIR}/bin/z3" >> $GITHUB_ENV
          echo "SOTERIA_AUTO_INCLUDE_PATH=${PACKAGE_DIR}/lib/soteria-c" >> $GITHUB_ENV
          echo "SOTERIA_C=${PACKAGE_DIR}/bin/soteria-c" >> $GITHUB_ENV
          echo "SOTERIA_SOLVER_TIMEOUT=100" >> $GITHUB_ENV
          echo "SOTERIA_USE_CERB_HEADERS=true" >> $GITHUB_ENV
      - name: Create compilation database
        run: |
          mkdir -p build
          cd build
          cmake -DCMAKE_EXPORT_COMPILE_COMMANDS=1 ..
      - name: Run soteria-c on Collections-C (expecting exit code 13)
        run: |
          set +e
          $SOTERIA_C capture-db build/compile_commands.json
          EXIT_CODE=$?
          if [ $EXIT_CODE -ne 13 ]; then
            echo "Expected exit code 13, but got $EXIT_CODE"
            exit 1
          fi
          echo "✓ Collections-C test passed (found expected bug, exit code 13)"
      - name: Checkout Soteria repository for test files
        uses: actions/checkout@v4
        with:
          path: soteria-repo
      - name: Test symbolic execution with sym.c (nondet test)
        working-directory: soteria-repo/soteria-c/test/cram/simple.t
        run: |
          echo "Testing sym.c (verifying __soteria___nondet_int is found)"
          $SOTERIA_C exec sym.c --no-ignore-parse-failures --no-ignore-duplicate-symbols --print-states
          echo "✓ sym.c test passed (symbolic execution with nondet successful)"

  test-soteria-rust-package:
    name: Test soteria-rust Package
    strategy:
      matrix:
        operating-system: [macos-latest]
    runs-on: ${{ matrix.operating-system }}
    needs: build
    steps:
      - name: Get Rust toolchain
        run: curl https://raw.githubusercontent.com/$OBOL_REPO/$OBOL_COMMIT_HASH/rust-toolchain.toml > rust-toolchain
      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Download package
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.operating-system }}-soteria-rust-package
          path: soteria-rust-package
      - name: Add executable permissions
        run: |
          chmod +x ./soteria-rust-package/bin/soteria-rust
          chmod +x ./soteria-rust-package/bin/z3
          chmod +x ./soteria-rust-package/bin/obol
          chmod +x ./soteria-rust-package/bin/charon
          chmod +x ./soteria-rust-package/bin/obol-driver
          chmod +x ./soteria-rust-package/bin/charon-driver
      - name: Setup environment variables
        run: |
          PACKAGE_DIR="${GITHUB_WORKSPACE}/soteria-rust-package"
          echo "DYLD_LIBRARY_PATH=${PACKAGE_DIR}/lib:${DYLD_LIBRARY_PATH}" >> $GITHUB_ENV
          echo "SOTERIA_Z3_PATH=${PACKAGE_DIR}/bin/z3" >> $GITHUB_ENV
          echo "SOTERIA_OBOL_PATH=${PACKAGE_DIR}/bin/obol" >> $GITHUB_ENV
          echo "SOTERIA_CHARON_PATH=${PACKAGE_DIR}/bin/charon" >> $GITHUB_ENV
          echo "SOTERIA_RUST_PLUGINS=${PACKAGE_DIR}/plugins" >> $GITHUB_ENV
          echo "SOTERIA_RUST=${PACKAGE_DIR}/bin/soteria-rust" >> $GITHUB_ENV
      - name: Run soteria-rust --help (smoke test)
        run: |
          $SOTERIA_RUST --help
          echo "soteria-rust smoke test passed"
      - name: Test basic Miri plugin (simple.t tests)
        working-directory: soteria-rust/test/cram/simple.t
        run: |
          echo "Testing leak.rs (Miri plugin)"
          set +e
          $SOTERIA_RUST rustc leak.rs
          EXIT_CODE=$?
          if [ $EXIT_CODE -ne 1 ]; then
            echo "Expected exit code 1 for leak.rs, but got $EXIT_CODE"
            exit 1
          fi
          echo "✓ leak.rs test passed (found expected memory leak)"

          echo "Testing char_min_max.rs (Miri plugin)"
          set -e
          $SOTERIA_RUST rustc char_min_max.rs
          echo "✓ char_min_max.rs test passed"
      - name: Test Kani plugin (kani.t tests)
        working-directory: soteria-rust/test/cram/kani.t
        run: |
          echo "Testing any.rs (Kani plugin)"
          $SOTERIA_RUST rustc any.rs --kani
          echo "✓ any.rs test passed"

          echo "Testing assume.rs (Kani plugin)"
          $SOTERIA_RUST rustc assume.rs --kani
          echo "✓ assume.rs test passed"
      - name: Test Rusteria plugin (rusteria-lib.t tests)
        working-directory: soteria-rust/test/cram/rusteria-lib.t
        run: |
          echo "Testing lib-fns.rs (Rusteria plugin)"
          $SOTERIA_RUST rustc lib-fns.rs
          echo "✓ lib-fns.rs test passed"

          echo "Testing annots.rs (Rusteria annotations)"
          $SOTERIA_RUST rustc annots.rs
          echo "✓ annots.rs test passed"
      - name: Test polymorphic support (poly.t tests)
        working-directory: soteria-rust/test/cram/poly.t
        run: |
          echo "Testing trivial.rs (polymorphic support with Charon)"
          $SOTERIA_RUST rustc trivial.rs --frontend charon --poly
          echo "✓ trivial.rs test passed"

          echo "Testing vec.rs (polymorphic Vec support)"
          set +e
          $SOTERIA_RUST rustc vec.rs --frontend charon --poly
          EXIT_CODE=$?
          if [ $EXIT_CODE -ne 1 ]; then
            echo "Expected exit code 1 for vec.rs, but got $EXIT_CODE"
            exit 1
          fi
          echo "✓ vec.rs test passed (found expected assertion failure)"

  publish-doc:
    name: Publish documentation
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Retrieve documentation artifact
        uses: actions/download-artifact@v4
        with:
          name: odoc
          path: site

      - name: Deploy
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
          destination_dir: ./api/main

      - run: echo "Successfully published documentation to https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/api/main"

