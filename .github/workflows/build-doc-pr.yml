name: Build PR Documentation

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pages: write
  id-token: write
  pull-requests: write
  actions: read

jobs:
  publish-pr-doc:
    name: Publish PR Documentation
    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '!build-doc') &&
      contains(fromJSON('["COLLABORATOR", "MEMBER", "OWNER"]'), github.event.comment.author_association)
    runs-on: ubuntu-latest
    steps:
      - name: Add eyes reaction
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'eyes'
            });

      - name: Get PR details
        id: pr
        run: |
          PR_DATA=$(gh pr view ${{ github.event.issue.number }} --repo ${{ github.repository }} --json headRefOid)
          SHA=$(echo "$PR_DATA" | jq -r .headRefOid)
          echo "sha=$SHA" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Find CI workflow run
        id: find-run
        run: |
          # Wait up to 5 minutes for a CI run to appear for this commit
          MAX_ATTEMPTS=30
          ATTEMPT=0
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            RUN_ID=$(gh run list --repo ${{ github.repository }} \
              --commit ${{ steps.pr.outputs.sha }} \
              --workflow ci.yml \
              --json databaseId,status \
              --jq '.[0].databaseId // empty')
            
            if [ -n "$RUN_ID" ]; then
              echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            echo "Waiting for CI workflow to start... (attempt $((ATTEMPT + 1))/$MAX_ATTEMPTS)"
            sleep 10
            ATTEMPT=$((ATTEMPT + 1))
          done

          echo "No CI workflow run found for commit ${{ steps.pr.outputs.sha }}"
          exit 1
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Wait for CI workflow to complete
        id: wait-ci
        run: |
          gh run watch ${{ steps.find-run.outputs.run_id }} --repo ${{ github.repository }} --exit-status
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download documentation artifact
        uses: actions/download-artifact@v4
        with:
          name: odoc
          path: site
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ steps.find-run.outputs.run_id }}

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
          destination_dir: ./api/pr-${{ github.event.issue.number }}

      - name: Add rocket reaction on success
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });

      - name: Post documentation URL
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = context.payload.issue.number;
            const url = `https://${owner}.github.io/${repo}/api/pr-${prNumber}`;
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body: `Documentation published at: ${url}. It should appear online in a few minutes.`
            });

      - name: Add failure reaction
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: '-1'
            });

      - name: Post failure comment
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = context.payload.issue.number;
            const runUrl = `https://github.com/${owner}/${repo}/actions/runs/${{ github.run_id }}`;
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body: `Failed to publish documentation. See [workflow run](${runUrl}) for details.`
            });
