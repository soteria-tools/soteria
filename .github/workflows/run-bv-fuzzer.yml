name: Run BV Fuzzer

on:
  workflow_dispatch:
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write

env:
  # [versionsync: OCAML_VERSION=5.4.0]
  OCAML_VERSION: 5.4.0

jobs:
  run-bv-fuzzer:
    name: Run BV Fuzzer
    # Run on workflow_dispatch OR on PR comment with !run-bv-fuzzer
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event.issue.pull_request &&
       contains(github.event.comment.body, '!run-bv-fuzzer') &&
       contains(fromJSON('["COLLABORATOR", "MEMBER", "OWNER"]'), github.event.comment.author_association))
    runs-on: macos-latest
    steps:
      - name: Add eyes reaction
        if: github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'eyes'
            });

      - name: Get PR details
        if: github.event_name == 'issue_comment'
        id: pr
        run: |
          PR_DATA=$(gh pr view ${{ github.event.issue.number }} --repo ${{ github.repository }} --json headRefName,headRefOid)
          BRANCH=$(echo "$PR_DATA" | jq -r .headRefName)
          SHA=$(echo "$PR_DATA" | jq -r .headRefOid)
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "sha=$SHA" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'issue_comment' && steps.pr.outputs.sha || 'main' }}

      - name: Setup Z3
        uses: cda-tum/setup-z3@v1
        id: z3

      - name: Setup OCaml
        uses: ocaml/setup-ocaml@v3
        with:
          ocaml-compiler: ${{ env.OCAML_VERSION }}
          dune-cache: true
          opam-pin: false

      - name: Restore opam cache
        uses: actions/cache/restore@v4
        with:
          path: _opam
          key: ${{ runner.os }}-${{ runner.arch }}-opam-${{ env.OCAML_VERSION }}-${{ hashFiles('*.opam') }}
          restore-keys: |
            ${{ runner.os }}-${{ runner.arch }}-opam-${{ env.OCAML_VERSION }}-

      - name: Update opam
        run: opam update

      - name: Install dependencies
        run: make soteria-core-deps

      - name: Run the BV simlification fuzzer
        run: make ocaml-very-slow-tests

      - name: Add rocket reaction on success
        if: success() && github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });

      - name: Post success comment
        if: success() && github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = context.payload.issue.number;
            const runUrl = `https://github.com/${owner}/${repo}/actions/runs/${{ github.run_id }}`;
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body: `✅ BV fuzzer tests passed! See [workflow run](${runUrl}) for details.`
            });

      - name: Add failure reaction
        if: failure() && github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: '-1'
            });

      - name: Post failure comment
        if: failure() && github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = context.payload.issue.number;
            const runUrl = `https://github.com/${owner}/${repo}/actions/runs/${{ github.run_id }}`;
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body: `❌ BV fuzzer tests failed. See [workflow run](${runUrl}) for details.`
            });
